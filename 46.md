NIP-46
======

Nostr Remote Signing
--------------------

## 変更点

`リモート署名鍵`が導入され、バンカーurlで渡される。クライアントは`リモート署名器公開鍵`と`ユーザー公開鍵`を区別する必要があり、接続後に`get_public_key`メソッドを呼び出す必要がある。nip05ログインが削除され、create_accountメソッドは別のNIPに移動された。

## 根拠

秘密鍵は、システムアプリ、オペレーティングシステム、デバイスなど、システムが増えるごとに攻撃対象が増えるため、できるだけ少ないシステムに公開されるべきである。

このNIPは**リモート署名器**と通常のNostrクライアント間の双方向通信の方法について記述している。リモート署名器は、例えばNostrイベントに署名する専用のハードウェアデバイスで、クライアントは通常のNostrクライアントである。

## 用語

- **ユーザー**: Nostrを使用しようとしている人。
- **クライント**: _ユーザー_が見たりボタンをクリックしたりするユーザー向けアプリケーション。
- **リモート署名器**: _クライアント_からのリクエストに応答するデーモンまたはサーバー。
- **クライアント鍵ペア/公開鍵**: _client_によって生成された鍵。コンテンツを暗号化し、_リモート署名器_と通信するために使用される。
- **リモート署名器鍵ペア/公開鍵**: _リモート署名器_がコンテンツを暗号化し、_クライアント_と通信するために使用される鍵。この鍵ペアは_ユーザー鍵ペア/公開鍵_と同じであっても良い (MAY) が、必ずしもそうである必要はない。
- **ユーザー鍵ペア/公開鍵**: _ユーザー_を表す実際の鍵。(例えば、`sign_event`リクエストに応じてイベントへ署名するために使用される。) 通常、_リモート署名器_がこれらの鍵を管理する。

このNIPで指定されたすべての公開鍵は16進数形式である。

## 概説

1. _クライアント_が`クライアント鍵ペア`を生成する。この鍵ペアは主に使い捨てであるため_ユーザー_に伝える必要はない。クライアントはそれをローカルに保存することを選択できるが、ログアウト時に削除するべきである。
2. 接続が確立され、 (下記参照) _リモート署名器_は`クライアント公開鍵`を得て、_クライアント_は`リモート署名器公開鍵`を得る。
3. _クライアント_は`クライアント鍵ペア`を使用して`リモート署名器公開鍵`へ`p`タグを付け、暗号化して_リモート署名器_にリクエストを送信する。
4. _リモート署名器_は`クライアント公開鍵`へ`p`タグを付け、暗号化して _クライアント_ に応答する。
5. _クライアント_は`ユーザー公開鍵`を得るために`get_public_key`をリクエストする。

## 接続の開始

接続を開始するには、2つの方法がある。

### リモート署名器によって直接接続が開始される場合

_リモート署名器_は、接続トークンを以下の形式で提供する:

```
bunker://<リモート署名器公開鍵>?relay=<wss://接続するリレー>&relay=<wss://接続する別のリレー>&secret=<オプションのシークレット>
```

このトークンはユーザーによって_クライアント_に渡され、クライアントは指定されたリレーを介してリモート署名器に`connect`リクエストを送る。オプションのシークレットは、正常な1回の接続確立にのみ使用でき、_リモート署名者_は古いシークレットを用いて新たに接続を確立しようとする試みを無視するべきだ (SHOULD)。

### クライアントによって直接接続が開始される場合

_クライアント_は次のような接続トークンを提供する:

```
nostrconnect://<クライアント公開鍵>?relay=<wss://接続するリレー>&metadata=<json metadata: {"name":"...", "url": "...", "description": "...", "perms": "..."}>&secret=<必須のシークレット>
```
このトークンはユーザーによって_リモート署名器_に渡され、リモート署名器は指定されたリレーを介して`クライアント公開鍵`に`connect`*応答*イベントを送る。クライアントは接続応答の作成者から`リモート署名器公開鍵`を探す。接続相手のなりすましを防ぐために`シークレット`値を指定する必要があり (MUST) _クライアント_は`connect`応答によって得られた`シークレット`を検証する必要がある (MUST)。

## リクエストイベント `kind: 24133`

```jsonc
{
    "kind": 24133,
    "pubkey": <ローカル鍵ペア公開鍵>,
    "content": <nip04(<リクエスト>)>,
    "tags": [["p", <リモート署名器公開鍵>]],
}
```

`content`フィールドは以下のような構造を持つ[NIP-04](04.md)暗号化されたJSON-RPC風のメッセージである。

```jsonc
{
    "id": <ランダム文字列>,
    "method": <メソッド名>,
    "params": [文字列の配列]
}
```

- `id`はリクエストIDであるランダムな文字列である。同じIDが応答ペイロードで返される。
- `method`はメソッド/コマンドの名前である (詳細は下記参照)。
- `params`はパラメータ文字列の位置配列である。

### メソッド/コマンド

Each of the following are methods that the _client_ sends to the _remote-signer_.
以下はそれぞれ、 _クライアント_ が _リモート署名器_ に送信するメソッドである。

| コマンド                  | パラメータ                                                                        | 結果                                                                 |
| ------------------------ | -------------------------------------------------                             | ---------------------------------------------------------------------- |
| `connect`                | `[<リモート署名器公開鍵>, <オプションのシークレット>, <オプションの要求される権限>]`        | "ack" または `<必須のシークレット値>`                                                                  |
| `sign_event`             | `[<{kind, content, tags, created_at}>]`                                       | `json_stringified(<署名済イベント>)`                                     |
| `ping`                   | `[]`                                                                          | "pong"                                                                 |
| `get_relays`             | `[]`                                                                          | `json_stringified({<リレーURL>: {read: <boolean>, write: <boolean>}})` |
| `get_public_key`         | `[]`                                                                          | `<user-pubkey>`                                                         |
| `nip04_encrypt`          | `[<第三者の公開鍵>, <暗号化する平文>]`                              | `<nip04暗号文>`                                                   |
| `nip04_decrypt`          | `[<第三者の公開鍵>, <復号するnip04暗号文>]`                       | `<平文>`                                                          |
| `nip44_encrypt`          | `[<第三者の公開鍵>, <暗号化する平文>]`                              | `<nip44暗号文>`                                                   |
| `nip44_decrypt`          | `[<第三者の公開鍵>, <複合するnip44暗号文>]`                       | `<plaintext>`                                                          |

### 要求される権限

ユーザーの利便性のために、`connect`メソッドは`オプションの要求される権限`と一緒に提供されるかもしれない。権限はコンマで区切られた`メソッド[:パラメータ]のリストである。例えば、`nip04_encrypt,sign_event:4`は`nip04_encrypt`と`kind:4`の`sign_event`を呼び出す権限を意味する。`nostrconnect://`文字列内の`metadata`の`perms`フィールドにも同じ権限形式を利用できる。

## 応答イベント `kind:24133`

```json
{
    "id": <id>,
    "kind": 24133,
    "pubkey": <リモート署名器公開鍵>
    "content": <nip04(<応答>)>,
    "tags": [["p", <クライアント公開鍵>]],
    "created_at": <秒単位のUNIXタイムスタンプ>
}
```

The `content` field is a JSON-RPC-like message that is [NIP-04](04.md) encrypted and has the following structure:
`content`フィールドは以下のような構造を持つ[NIP-04](04.md)暗号化されたJSON-RPC風のメッセージである。

```json
{
    "id": <リクエストID>,
    "result": <結果文字列>,
    "error": <オプションのエラー文字列>
}
```

- `id`は応答するリクエストIDである。
- `results`は呼び出し結果の文字列である。(文字列またはJSON文字列化オブジェクトのいずれかになる。)
- `error`、文字列形式のエラーである ( _オプション_ )。存在する場合、リクエストのエラーを示す。

## イベントに署名する際のフロー

- `リモート署名器公開鍵` は `fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52`
- `ユーザー公開鍵` は `fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52`
- ` クライアント公開鍵` は `eff37350d839ce3707332348af4549a96051bd695d3223af4aabce4993531d86`

### 署名リクエスト

```jsonc
{
    "kind": 24133,
    "pubkey": "eff37350d839ce3707332348af4549a96051bd695d3223af4aabce4993531d86",
    "content": nip04({
        "id": <ランダム文字列>,
        "method": "sign_evet",
        "params": [json_stringified(<{
            content: "Hello, I'm signing remotely",
            kind: 1,
            tags: [],
            created_at: 1714078911
        }>)]
    }),
    "tags": [["p", "fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52"]], // リモート署名器の公開鍵にpタグを付ける。
}
```

### 応答イベント

```jsonc
{
    "kind": 24133,
    "pubkey": "fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52",
    "content": nip04({
        "id": <ランダム文字列>,
        "result": json_stringified(<署名済イベント>)
    }),
    "tags": [["p", "eff37350d839ce3707332348af4549a96051bd695d3223af4aabce4993531d86"]], // クライアント公開鍵にpタグを付ける
}
```

### 表

![signing-example](https://i.nostr.build/P3gW.png)


## 認証チャレンジ

認証チャレンジは _ユーザー_ に他の手段による認証が必要な場合に _リモート署名器_ が送り返せる応答である。応答の`content`は次のようになる

```json
{
    "id": <リクエストID>,
    "result": "認証URL",
    "error": <エンドユーザーに表示するURL>
}
```

_クライアント_ はポップアップまたは新しいタブで`error`フィールドのURLを表示し、リモート署名器からの別の応答を購読/待機する必要がある。(同じリクエストIDを再利用する。)

### 認証チャレンジを含むイベント署名リクエストの例

![signing-example-with-auth-challenge](https://i.nostr.build/W3aj.png)

## 補遺

### _リモート署名器_ メタデータのアナウンス

_remote-signer_ MAY publish it's metadata by using [NIP-05](05.md) and [NIP-89](89.md). With NIP-05, a request to `<remote-signer>/.well-known/nostr.json?name=_` MAY return this:
_リモート署名器_ は[NIP-05](05.md)および[NIP-89](89.md)を使用してメタデータを公開してもいい (MAY)。NIP-05では、`<リモート署名器>/.well-known/nostr.json?name=_` へのリクエストは以下の応答を返す場合がある。
```jsonc
{
    "names":{
        "_": <リモート署名器アプリ公開鍵>,
    },
    "nip46": {
        "relays": ["wss://relay1","wss://relay2"...],
        "nostrconnect_url": "https://remote-signer-domain.com/<nostrconnect>"
    }
}
```

The `<remote-signer-app-pubkey>` MAY be used to verify the domain from _remote-signer_'s NIP-89 event (see below). `relays` SHOULD be used to construct a more precise `nostrconnect://` string for the specific `remote-signer`. `nostrconnect_url` template MAY be used to redirect users to _remote-signer_'s connection flow by replacing `<nostrconnect>` placeholder with an actual `nostrconnect://` string.
`<リモート署名器アプリ公開鍵`はリモート署名器のNIP-89イベントからドメインを検証するために使用できる (MAY) (下記参照)。`relays`は特定の`リモート署名器`に対するより正確な`nostrconnect://`文字列を構築するために使用されるべきだ (SHOULD)。`nostrconnect_url`テンプレートは<nostrconnect>プレースホルダーを実際の`nostrconnect://`文字列に置き換えることにより、ユーザーをリモート署名器の接続フローにリダイレクトするために使用できる (MAY)。

### NIP-89によるリモート署名器発見

_リモート署名器_ は`24133`の`k`タグを持つNIP-89`kind: 31990`イベントを発行しても良く (MAY)、これには1つ以上の`relay`タグが含まれていても良く (MAY)、`nostrconnect_url`タグが含まれていても良い (MAY)。`relay`タグと`nostrconnect_url`の意味論は上の節と同じである。

_クライアント_ はその`kind: 31990`イベントを用いて _リモート署名器_ を発見することでユーザー体験を改善しても良い (MAY)。 _クライアント_ はリモート署名器用に`nostrconnect_url://`文字列を事前に生成していても良く (MAY)、その場合は`kind: 31990`イベントの作成者が署名者の`nostr.json?name=_`ファイルに`<リモート署名者アプリ公開鍵>`として記載されていることを検証する必要がある (SHOULD)。
